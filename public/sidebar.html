<!DOCTYPE html>
<html>
  <head>
    <base target="_top" />
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sidebar</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --primary-color: #28466c;
        --secondary-color: #00afcc;
      }

      body {
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100vh;
        box-sizing: border-box;
        font-family: "Press Start 2P", sans-serif;
        display: flex;
        justify-content: center;
        align-items: flex-start;
        overflow: hidden;
        user-select: none;
      }

      .adventure-image-container {
        position: fixed;
        left: 0;
        top: 0;
        width: 100vw;
        height: 100px;
        overflow: hidden;
        z-index: -1;
        transition: height 1.5s ease-in-out;
      }

      .adventure-image {
        width: 100vw;
        height: auto;
        object-fit: cover;
        position: absolute;
        bottom: 0;
      }

      #side-panel {
        width: 300px;
        height: 100vh;
        background-color: rgba(40, 70, 108, 0.9);
        position: relative;
        display: flex;
        flex-direction: column;
        z-index: 1;
      }

      .content-wrapper {
        flex: 1;
        overflow-y: hidden;
        padding-bottom: 60px;
      }


      .card {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        padding: 20px;
        box-sizing: border-box;
      }

      .card-content::after {
        content: "";
        display: block;
        height: 50px;
        background: linear-gradient(to bottom, transparent, #ffffff);
        position: sticky;
        bottom: 0;
        pointer-events: none;
      }

      .card::-webkit-scrollbar,
      .card-main-text::-webkit-scrollbar {
        width: 8px;
      }

      .card::-webkit-scrollbar-track,
      .card-main-text::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 4px;
      }

      .card::-webkit-scrollbar-thumb,
      .card-main-text::-webkit-scrollbar-thumb {
        background: #ccc;
        border-radius: 4px;
      }

      .card::-webkit-scrollbar-thumb:hover,
      .card-main-text::-webkit-scrollbar-thumb:hover {
        background: #999;
      }

      .card p {
        margin: 0 0 10px 0;
        color: var(--primary-color);
        font-weight: 600;
      }

      button {
        padding: 20px 20px;
        font-size: 16px;
        cursor: pointer;
        background-color: var(--primary-color);
        color: white;
        border: none;
        border-radius: 4px;
        transition: background-color 0.3s ease, transform 0.3s ease;
      }

      button:hover {
        transform: scale(1.05);
      }

      @keyframes pulse {
        0% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.05);
        }
        100% {
          transform: scale(1);
        }
      }

      .topic-button {
        display: flex;
        align-items: center;
        gap: 10px;
        background: #ececec;
        border: none;
        padding: 8px;
        width: 90%;
        cursor: pointer;
        border-radius: 40px;
        box-sizing: border-box;
        transition: background-color 0.3s ease;
        transition: transform 0.3s ease-in-out;
      }

      .topic-button:hover {
        transform: none;
        background: #e0e0e0;
      }

      .progress-bar {
        width: 50px;
        height: 20px;
        background-color: #59cc01;
        border-radius: 15px;
        position: relative;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 12px;
        font-weight: 500;
        font-family: "Inter", sans-serif;
        overflow: hidden;
      }

      .inner-pill {
        width: 70%;
        height: 25%;
        background-color: #80d741;
        border-radius: 15px;
        position: absolute;
        left: 5px;
        top: 35%;
        transform: translateY(-50%);
        z-index: 1;
      }

      .inner-empty-pill {
        position: absolute;
        top: 0;
        right: 0;
        height: 100%;
        background-color: #838282;
        border-radius: 0 15px 15px 0;
        transition: width 0.3s ease;
        z-index: 2;
      }

      .progress-bar span {
        position: relative;
        z-index: 3;
      }

      .label {
        color: var(--primary-color);
        font-size: 14px;
        text-align: left;
        flex-grow: 1;
        font-weight: 600;
      }

      /* Apply Inter font to everything */
      * {
        font-family: "Inter", sans-serif;
      }

      .stats-box {
        margin-top: auto;
        margin-top: 20px;
        padding-top: 5px;
        border-top: 1px solid #e0e0e0;
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .stat-row {
        display: flex;
        flex-direction: column;
        color: var(--primary-color);
      }

      .stat-label {
        font-size: 12px;
        font-weight: 400;
        color: #666;
      }

      .stat-value {
        font-size: 14px;
        font-weight: 600;
      }
      .card-title,
      .card-title-home {
        color: var(--primary-color);
        font-size: 1.2em;
        font-weight: bold;
        text-align: left;
        font-family: "Inter", sans-serif; /* Professional font */
        margin-bottom: 14px; /* Space below the title */
        margin-top: 0px; /* Space below the title */
      }
      .card-title-subtitle {
        font-size: 1em;
        font-weight: 600;
        color: #666;
        margin-bottom: 30px;
      }
      .card-title-subtitle-feedback {
        font-size: 1em;
        font-weight: 600;
        color: #666;
        margin-top: 20px;
        margin-bottom: 10px;
      }

      .card-title-home {
        font-size: 0.8em;
      }

      .card-main-text {
        white-space: pre-wrap;

        margin: 0;
        font-size: 12px;
        font-weight: normal;
        flex: 0 1 auto;
      }

      .card-content,
      .card-main-text {
        flex: 1;
        overflow-y: auto;
        padding-right: 10px;
        position: relative;
      }

      .card-main-text,
      .card-content {
        font-size: 13px; /* Standard font size for body text */
        font-weight: 400; /* Normal weight for readability */
        color: #555; /* Medium gray for a softer look */
        line-height: 1.6; /* Increased line height for readability */
        font-family: "Inter", sans-serif; /* Consistent font choice */
      }

      #focus-sentence .card-main-text {
        font-size: 12px;
        font-style: italic;
      }

      .level-up-button {
        background: var(
          --secondary-color
        ); /* Use secondary color for background */
        border: none;
        padding: 8px 10px;
        border-radius: 25px;
        cursor: pointer;
        font-size: 10px;
        color: white; /* Ensure text is readable on secondary color */
        transition: background-color 0.3s ease;
        width: 90%;
        margin: 10px 5px;
        text-align: center;
        display: flex; justify-content: center;
        height: 35px;
      }


      .level-up-button:hover {
        background: #00c2e3; /* Slightly lighter shade for hover effect */
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      }

      .nav-button {
        padding: 10px 20px;
        font-size: 16px;
        cursor: pointer;
        background-color: white;
        color: var(--primary-color);
        border: 2px solid var(--primary-color);
        border-radius: 25px;
        transition: background-color 0.3s ease, transform 0.3s ease;
      }

      .nav-button:hover {
        background-color: var(--secondary-color);
        color: white;
        transform: scale(1.05);
      }
      #next-button,
      #back-button,
      #check-work-button {
        display: inline-block; /* Ensure buttons are displayed */
      }

      #back-button {
        background-color: white;
        color: var(--primary-color);
        border: 2px solid var(--primary-color);
      }

      #back-button:hover {
        background-color: var(--secondary-color);
        color: white;
        border-color: var(--secondary-color);
        transform: scale(1.05);
      }

      #next-button, #start-edits-button, #save {
        background-color: var(--secondary-color);
        color: white;
        border: 2px solid var(--secondary-color);
        box-shadow: 0 2px 4px rgba(0, 175, 204, 0.3);
      }

      #next-button, #start-edits-button, #save:hover {
        background-color: #00c2e3;
        border-color: #00c2e3;
        transform: scale(1.05);
        box-shadow: 0 4px 8px rgba(0, 175, 204, 0.4);
      }

      /* Original height when buttons are visible */
      .button-box {
        flex: 1;
        display: flex;
        flex-direction: column;
        background: rgba(255, 255, 255, 1);
        border-radius: 8px 8px 0px 0px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        margin: 100px 20px 20px 20px;
        box-sizing: border-box;
        height: calc(100vh - 100px);
        position: relative;
        z-index: 1;
        padding: 20px; /* Add padding for better spacing */
        padding-top: 30px;

        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); /* Subtle shadow for depth */
      }



      .button-box.is-scrollable {
        padding-right: 0px;
        padding-top: 0px;
      }

      .example-block {
        margin-bottom: 30px;
      }

      .example-title {
        font-size: 0.9em;
        font-weight: 600;
        font-size: 12px;
        font-weight: 400;
        color: #666;
        margin-bottom: 5px;
      }

      .original::before,
      .fixed::before {
        display: none;
      }

      .spinner-overlay {
        display: flex;
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.9); /* semi-transparent white */
        justify-content: center;
        align-items: center;
        z-index: 1000;
        border-radius: 8px; /* match button-box border radius */
        flex-direction: column;
        gap: 20px; /* space between spinner and text */
      }

      .spinner {
        width: 40px;
        height: 40px;
        border: 4px solid var(--primary-color);
        border-top: 4px solid var(--secondary-color);
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      .spinner-text {
        color: var(--primary-color);
        font-size: 16px;
        font-weight: 500;
        font-family: "Inter", sans-serif;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .cards-wrapper {
        flex: 1;
        display: flex;
        flex-direction: column;
        margin: 20px; /* Add margin to match button container */
      }

      .card {
        display: none; /* Hide all cards by default */
        flex-direction: column;
        height: 100%;
        padding: 0;
        box-sizing: border-box;
        overflow: hidden;
      }

      .card-content {
        flex: 1;
        overflow-y: auto;
        padding: 20px 20px 0px 20px;
        box-sizing: border-box;
      }

      .button-container {
        display: flex;
        justify-content: space-between;
        padding-top: 10px;
      }
      .button-container.is-scrollable {
        padding-right: 20px;
      }
      .scroll-container {
        flex: 1;
        overflow-y: auto;
        position: relative;
        margin: 0;
        padding: 0px;
        width: 100%;
        box-sizing: border-box;
      }

      .scroll-container::after {
        content: "";
        display: none;
        height: 50px;
        background: linear-gradient(to bottom, transparent, #ffffff);
        position: sticky;
        bottom: 0;
        pointer-events: none;
        z-index: 1;
      }

      .scroll-container.is-scrollable::after {
        display: block; /* Show when scrollable */
      }

      .scroll-container.is-scrollable::before {
        content: "";
        display: block;
        height: 40px;
        background: linear-gradient(to top, transparent, #ffffff);
        position: sticky;
        top: 0px;
        pointer-events: none;
        z-index: 1;
      }

      /* custom scrollbar */
      ::-webkit-scrollbar {
        width: 20px;
      }

      ::-webkit-scrollbar-track {
        background-color: transparent;
      }

      ::-webkit-scrollbar-thumb {
        background-color: rgba(40, 70, 108, 0.5);
        border-radius: 20px;
        border: 6px solid transparent;
        background-clip: content-box;
        min-height: 70px;
      }

      ::-webkit-scrollbar-thumb:hover {
        background-color: rgba(40, 70, 108, 0.8);
      }

      .card-content {
        flex: 1;
      }

      #pillHolder {
        display: flex;
        flex-direction: column;
        align-items: center;
        margin-bottom: 5px;
        width: 100%;
      }
      .home-button {
        display: flex;
        align-items: center;
        gap: 10px;
        background: #ececec;
        border: none;
        padding: 8px;
        width: 90%;
        cursor: pointer;
        border-radius: 40px;
        box-sizing: border-box;
        transition: background-color 0.3s ease;
        font-size: 16px; /* Adjust font size if needed */
        color: var(--primary-color); /* Use primary color */
      }

      .select-button {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        background: #ececec;
        border: none;
        padding: 8px;
        margin-bottom: 20px;
        width: 90%;
        cursor: pointer;
        border-radius: 40px;
        box-sizing: border-box;
        transition: background-color 0.3s ease;
        font-size: 16px; /* Adjust font size if needed */
        color: var(--primary-color); /* Use primary color */
      }
      .home-button,
      .select-button:hover {
        background: #e0e0e0;
        transform: none;
      }

      .topic-button {
        width: 80%;
        margin-bottom: 5px;
        box-sizing: border-box;
      }

      /* Add this new style for the challenge complete button */
      #next-button.challenge-complete {
        background-color: #59cc01; /* Same green as progress bars */
        border-color: #59cc01;
      }

      #next-button.challenge-complete:hover {
        background-color: #80d741; /* Lighter green on hover */
        border-color: #80d741;
        transform: scale(1.05);
        box-shadow: 0 4px 8px rgba(89, 204, 1, 0.4);
      }

      #skip-button {
        background-color: white;
        color: var(--primary-color);
        border: 2px solid var(--primary-color);
        opacity: 0.7;
        padding: 5px 10px; /* Reduced padding */
        border-radius: 25px;
        cursor: pointer;
        font-size: 16px;
        transition: all 0.3s ease;
        flex: 1; /* Allow it to grow */
      }
      #skip-button:hover {
        background-color: lightcoral;
        opacity: 0.9;
        transform: scale(1.05);
        box-shadow: 0 4px 8px rgba(40, 70, 108, 0.4);
      }

      /* Add styles for the check work button */
      #check-work-button {
        display: block; /* Ensure it's visible */
        background-color: #59cc01;
        color: white;
        border: 2px solid #4ba001;
        padding: 5px 10px; /* Reduced padding */
        border-radius: 25px;
        cursor: pointer;
        font-size: 16px;
        transition: all 0.3s ease;
        flex: 1; /* Allow it to grow */
        margin-right: 20px;
      }

      #check-work-button:hover {
        background-color: #80d741;
        transform: scale(1.05);
        box-shadow: 0 4px 8px rgba(89, 204, 1, 0.4);
      }

      /* Add this to ensure proper button container layout */
      .challenge-button-container {
        display: flex;
        justify-content: space-between; /* Space out the buttons to opposite ends */
        margin-top: 10px;
        padding: 0 10px; /* Optional: Add some padding for spacing */
      }

      .task-list {
        display: flex;
        flex-direction: column;
        gap: 15px;
        padding: 10px 0;
      }

      .task-item {
        display: flex;
        align-items: flex-start;
        gap: 10px;
      }

      .task-checkbox {
        margin-top: 3px;
        cursor: pointer;
        width: 18px;
        height: 18px;
      }

      .task-text {
        flex: 1;
        color: var(--primary-color);
        font-size: 14px;
        line-height: 1.4;
      }

      .alert-message {
        color: #d73a49;
        background-color: #ffeef0;
        padding: 10px;
        border-radius: 4px;
        margin: 10px 0;
        font-size: 14px;
        text-align: center;
        border: 1px solid #f97583;
      }

      #check-work-button:disabled, #start-edits-button:disabled {
        background-color: #cccccc;
        border-color: #bbbbbb;
        cursor: not-allowed;
        opacity: 0.7;
        transform: none;
        box-shadow: none;
      }

      button:disabled {
  background-color: #d3d3d3 !important; /* Light gray */
  color: #808080 !important; /* Dark gray text */
  cursor: not-allowed !important;
  opacity: 0.6 !important;
  border: 1px solid #b0b0b0 !important;
  box-shadow: none !important;
  transform: none !important;
  transition: none !important;
  display: flex;
  align-items: center;
  justify-content: center;
}

/* Prevent hover and focus effects on disabled buttons */
button:disabled:hover,
button:disabled:active,
button:disabled:focus {
  background-color: #d3d3d3 !important;
  color: #808080 !important;
  cursor: not-allowed !important;
  box-shadow: none !important;
  transform: none !important;
}

/* Ensure button text remains centered */
button {
  display: flex;
  align-items: center;
  justify-content: center;
  text-align: center;
  line-height: normal;
}



      #check-work-button:disabled:hover {
        background-color: #cccccc;
        transform: none;
        box-shadow: none;
      }

      .alert-message.info {
        color: #0366d6;
        background-color: #f1f8ff;
        border: 1px solid #79b8ff;
      }

      .hot-air-balloon {
        position: absolute;
        left: 0; /* Align to the left side */
        bottom: 100%; /* Align the bottom of the image with the top of the button-box */
        height: 50px; /* Set the height of the image */
        transition: transform 1.5s ease, background-image 1.5s ease; /* Smooth transition */
      }

      .customize-link {
        font-size: 12px; /* Smaller text size */
        color: var(
          --primary-color
        ); /* Use primary color or any color you prefer */
        text-decoration: none; /* Remove underline */
        margin-top: 0; /* Remove space above the link */
        text-align: left; /* Align text to the left */
        display: block; /* Make it a block element for full width */
        transition: color 0.3s ease; /* Smooth color transition on hover */
        width: 70%; /* Match the width of the pill buttons */
        margin-left: auto; /* Align with the left side of the pill buttons */
        margin-right: auto; /* Center within the container */
      }

      .customize-divider {
        width: 80%; /* Match the width of the pill buttons */
        margin: 10px auto; /* Center the line and add vertical spacing */
        border: none; /* Remove default border */
        border-top: 1px solid var(--primary-color); /* Add custom border */
      }

      .customize-link:hover {
        color: var(--secondary-color); /* Change color on hover */
      }

      /* Fade out effect at the top */
    </style>
    <style>
      :root {
        --primary-color: #28466c;
        --secondary-color: #00afcc;
        --base-blue: #28466c;
        --stroke-color: #058c46;
        --gradient-light: #e5ff3c;
        --gradient-medium: #b8f043;
        --gradient-dark: #8fe045;
      }
      .pixelated-gradient-text {
        font-family: "Press Start 2P", sans-serif;
        font-size: 12px; /* Reduced size to fit container */
        -webkit-text-stroke: 0.5px var(--stroke-color);
        background: linear-gradient(
          to bottom,
          var(--gradient-light) 0%,
          var(--gradient-light) 40%,
          var(--gradient-medium) 40%,
          var(--gradient-medium) 55%,
          var(--gradient-dark) 55%,
          var(--gradient-dark) 100%
        );
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        text-align: center;
        line-height: 30px;
        width: 100%;
        height: 100%;
        margin: 0;
        padding: 0;
      }

      .level-text-container {
        width: 130px;
        height: 30px;
        background-color: var(--base-blue);
        border-radius: 5px;

        display: flex;
        justify-content: center;
        align-items: center;
        transition: background-color 2s ease, transform 2s ease;
        transform-style: preserve-3d;
        position: absolute;
        top: 85px; /* 100px -30/2 */
        left: 50%;
        transform: translateX(-50%);
        z-index: 2;
        box-shadow: -3px -3px 5px rgba(255, 255, 255, 0.1),
          3px 3px 5px rgba(0, 0, 0, 0.2), inset -2px -2px 5px rgba(0, 0, 0, 0.3),
          inset 2px 2px 5px rgba(255, 255, 255, 0.3);
        transition: all 0.2s ease;
      }

      .level-text {
        color: var(--primary-color);
        font-size: 3px;
        text-align: left;
        flex-grow: 1;
        font-weight: 600;
      }

      .reflection-textarea {
        width: 100%;
        min-height: 120px;
        padding: 12px 16px;
        border: 1px solid #dfe1e6;
        border-radius: 8px;
        background-color: #ffffff;
        color: #172b4d;
        font-family: "Inter", sans-serif;
        font-size: 14px;
        line-height: 1.6;
        resize: vertical;
        transition: border-color 0.2s ease, box-shadow 0.2s ease;
        margin-top: 12px;
        margin-bottom: 8px;
        box-sizing: border-box;
        resize: none;
      }

      .reflection-textarea:focus {
        outline: none;
        border-color: var(--secondary-color);
        box-shadow: 0 0 0 2px rgba(0, 175, 204, 0.2);
      }

      .reflection-textarea::placeholder {
        color: #97a0af;
      }

      .reflection-question {
        color: var(--primary-color);
        font-size: 14px;
        font-weight: 500;
        margin-bottom: 12px;
        line-height: 1.4;
        margin-top: 24px;
      }

      /* Optional: Add a character count display */
      .reflection-char-count {
        font-size: 12px;
        color: #97a0af;
        text-align: right;
        margin-top: 4px;
      }

      /* Optional: Add error state */
      .reflection-textarea.error {
        border-color: #ff5630;
      }

      .reflection-textarea.error:focus {
        box-shadow: 0 0 0 2px rgba(255, 86, 48, 0.2);
      }
    </style>
   <style>
    .full-width {
      width: 50%; /* Make buttons full width */
       margin: 0px 5px;; /* Add space between buttons */
    }
  
    .rubric-actions {
      display: flex;
      flex-direction: column; /* Stack buttons vertically */
      gap: 10px; /* Add space between buttons */
      margin-top:20px;
    }
  
    .url-container {
      display: flex;
      align-items: center;
      gap: 10px; /* Add space between input and button */
    }
  
    .share-url {
      flex: 1; /* Allow input to take up remaining space */
    }
    .rubric-label {
      font-size: 12px;
      color: #666;
      margin-bottom: 5px;
    }


/* Ensure the buttons are centered properly */
.rubric-actions {
  display: flex;
  flex-direction: column;
  align-items: center; /* Center-align buttons */
  gap: 12px;
  margin-top: 20px;
}

.full-width {
  width: 80%;
  max-width: 300px; /* Ensures buttons don‚Äôt stretch too much */
  padding: 12px;
  font-size: 16px;
  border-radius: 8px;
  cursor: pointer;
  text-align: center;
  transition: background-color 0.3s ease, transform 0.2s ease;
  display: flex;
  justify-content: center; /* Centers text inside button */
  align-items: center; /* Centers content */
  gap: 10px;
}
.rubric-section {
    display: flex;
    justify-content: center;
    align-items: center;
    margin: 0px 0;
}

.rubric-dropdown {
width: 210px; /* Keep it from stretching too much */
    padding: 12px;
    font-size: 12px;
    font-weight: 500;
    background-color: #ffffff;
    border: 2px solid #374363;
    border-radius: 8px;
    outline: none;
    cursor: pointer;
    appearance: none; /* Removes default styles in some browsers */
    position: relative;
    box-shadow: 0px 3px 6px rgba(0, 0, 0, 0.1);
    transition: border-color 0.3s ease, box-shadow 0.3s ease;
    
    /* Add a dropdown arrow */
    background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20"><path fill="%23374363" d="M7 10l5 5 5-5H7z"/></svg>');
    background-repeat: no-repeat;
    background-position: right 12px center;
    background-size: 20px;
}

.rubric-dropdown:focus {
    border-color: #2a6fc4;
    box-shadow: 0 0 4px rgba(42, 111, 196, 0.4);
}

.rubric-dropdown:hover {
    background-color: #f8f8f8;
}


  .rubric-actions {
    margin-top: 15px;
    text-align: center;
  }

  .rubric-load-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 10px;
    margin-top: 20px;
}

.rubric-label {
    font-size: 12px;
    color: #666;
}

.rubric-input {
    width: 96px;
    height:21px;
    padding: 5px;
    padding-left:10px;
    padding-right:10px;
    font-size: 14px;
    border: 2px solid #374363;
    border-radius: 8px;
    outline: none;
    text-align: left;
    margin-right:10px;

    transition: border-color 0.3s ease, box-shadow 0.3s ease;
}


.rubric-divider {
  margin: 10px 0;
  border: none;
  border-top: 1px solid #ccc;
}

.rubric-input::placeholder {
  color: #b6b9c0;      /* Example color */
  font-style: italic;    /* Example font style */
  /* Any other desired placeholder styling */
}

.rubric-input:focus {
    border-color: #2a6fc4;
    box-shadow: 0 0 4px rgba(42, 111, 196, 0.4);
}

.rubric-section {
  /* Let this container stack its children vertically */
  display: flex;
  flex-direction: column;
  align-items: flex-start;  /* Align items to the left (optional) */
  margin-bottom: 1rem;   
  padding-left:5px;   /* Space after the rubric section (optional) */
}

.rubric-section select {
  /* Ensure the dropdown is a full-width block so it doesn't sit on the same line */
  display: block;
  margin-bottom: 10px;      /* Spacing between the dropdown and the buttons */
}

.rubric-inline-actions {
  /* Put the Edit and Share buttons side by side */
  display: flex;
  flex-direction: row;
  gap: 0px;                /* Spacing between the buttons */
}

.rubric-inline-actions .level-up-button {
  /* Let each button expand, but limit to 25% of the viewport width */
  flex: 1;
  width: 75px;
  font-size: 13px;
  margin: 0px 0px;
margin-right:10px;
  border-radius: 10px;


}

.rubric-error {
  color: darkred !important; /* ‚úÖ Turns text dark red */
  font-weight: bold; /* ‚úÖ Optional: make it stand out */
}




  </style>
    </style>
  </head>
  <body>
    <div id="side-panel">
      <div class="adventure-image-container">
        <img
          src="https://wondersa.blob.core.windows.net/levelup/1.png"
          alt="Sky Background"
          class="adventure-image"
        />
      </div>
  
      <div class="content-wrapper">
        <div class="level-text-container">
          <div class="text-container">
            <div class="pixelated-gradient-text">Level 1</div>
          </div>
        </div>
  
        <!-- BEGIN .button-box (Hot air balloon + spinner + all cards) -->
        <div class="button-box">
          <img
            src="https://wondersa.blob.core.windows.net/levelup/hotAirBaloon.png"
            alt="Hot Air Balloon"
            class="hot-air-balloon"
          />
          <div class="spinner-overlay" id="spinner-overlay" style="display: none">
            <div class="spinner"></div>
            <div class="spinner-text">Reading Your Paper</div>
          </div>
  
          <!-- HOME PAGE CARD -->
          <div class="card" id="home-page" style="display: flex; flex: 1">
            <div class="scroll-container">
              <div class="card-title-home">Select Challenge:</div>
              <div id="pillHolder" style="display: flex; flex-direction: column"></div>
              <a href="#" class="customize-link">Customize</a>
  
              <div class="stats-box">
                <div class="stat-row">
                  <span class="stat-label">Copy/Pasted</span>
                  <span class="stat-value" id="copyPasted">60%</span>
                </div>
                <div class="stat-row">
                  <span class="stat-label">Time Spent</span>
                  <span class="stat-value" id="timeSpent">10 Hours 33 Minutes</span>
                </div>
              </div>
            </div>
          </div>
  
          <!-- AI-FEELING CARD -->
          <div class="card" id="AI-Feeling" style="display: none; flex: 1">
            <div class="scroll-container">
              <div class="card-title">First Take</div>
              <div class="card-main-text"></div>
            </div>
          </div>
  
          <!-- CELEBRATE CARD -->
          <div class="card" id="celebrateScreen" style="display: none; flex: 1">
            <div class="scroll-container">
              <div class="card-main-text">Default Text Here</div>
            </div>
          </div>
  
          <!-- SERVER ERROR CARD -->
          <div class="card" id="server-error" style="display: none; flex: 1">
            <div class="scroll-container">
              <div class="card-title">Server Error</div>
              <div class="error-message">
                We cannot get ahold of the Level Up Servers right now. 
                Please try again later. If this problem persists, please contact support.
              </div>
            </div>
          </div>
  
          <!-- CHALLENGE CARD -->
          <div class="card" id="challenge-card" style="display: none">
            <div class="scroll-container">
              <div class="card-title">Challenge</div>
              <div class="card-title-subtitle">Subtitle</div>
              <div class="alert-message" style="display: none"></div>
              <div class="alert-message fail-reason-message" style="display: none"></div>
              <div class="card-main-text">
                <!-- Tasks will be inserted here -->
              </div>
            </div>
          </div>
  
          <!-- FEEL RESPONSE CARD -->
          <div class="card" id="feel-response-card" style="display: none; flex: 1">
            <div class="scroll-container">
              <div class="card-title-subtitle">
                Let's work on the highlighted text in your document.
              </div>
              <div class="card-main-text"></div>
            </div>
          </div>
  
          <!-- FOCUS SENTENCE CARD -->
          <div class="card" id="focus-sentence" style="display: none; flex: 1">
            <div class="scroll-container">
              <div class="card-title">Let's Focus On The Highlighted Sentence:</div>
              <div class="card-main-text"></div>
            </div>
          </div>
  
          <!-- REFLECTION CARD -->
          <div class="card" id="reflection-card" style="display: none; flex: 1;">
            <div class="scroll-container">
              <div class="reflection-container">
                <div class="reflection-question"></div>
                <textarea
                  class="reflection-textarea"
                  placeholder="Share your thoughts..."
                ></textarea>
                <div
                  class="reflection-warning"
                  style="display: none; color: #374363; font-size: 12px; margin-top: -5px;"
                >
                  Please share your thoughts before pushing "Next".
                </div>
              </div>
            </div>
          </div>
  
          <!-- EXAMPLE CARD -->
          <div class="card" id="example-card" style="display: none; flex: 1">
            <div class="card feedback-panel">
              <h3 class="card-title">Example</h3>
              <div class="example-block">
                <div class="example-title">Poor Sentence</div>
                <div class="original">The leaves fell everywhere. Round 6</div>
              </div>
              <div class="example-block">
                <div class="example-title">Great Sentence</div>
                <div class="fixed">
                  The leaves fell on the ground, making a crunchy carpet for walking.
                </div>
              </div>
            </div>
          </div>
  
          <!-- CHALLENGE FEEDBACK CARD -->
          <div class="card" id="challenge-feedback-card" style="display: none; flex: 1">
            <div class="scroll-container">
              <div class="card-title">Challenge Completed!</div>
              <div class="card-main-text">
                Well done. Here's some more text two
              </div>
              <hr />
              <div class="card-title-subtitle-feedback">Now I want to:</div>
              <button class="level-up-button" id="improve-more-button">
                Improve this Sentence More
              </button>
              <button class="level-up-button" id="start-new-button">
                Start a New Sentence
              </button>
            </div>
          </div>
  

  
          <!-- CUSTOMIZE CARD (EDIT / NEW WINDOW) -->
<!-- CUSTOMIZE CARD -->

<div class="card" id="customize-card" style="display: none; flex: 1;">
  <div class="scroll-container">

    <!-- Rubric Dropdown and Edit/Share -->
    <div class="rubric-section">
      <div class="rubric-label">Current Rubric:</div>
      <select id="rubric-dropdown" class="rubric-dropdown">
        <option value="" disabled selected>Loading Rubrics...</option>
      </select>
      
      <div class="rubric-inline-actions">
        <button class="level-up-button" id="edit-rubric-button">Edit</button>
        <button class="level-up-button" id="share-rubric-button">Share</button>
      </div>
    </div>

    <hr class="rubric-divider" />

    <!-- Input & Add on the SAME line -->
     <div class="rubric-section" style="margin-bottom:0px">
      <div class="rubric-label" id="rubric-import-label">Import Rubric:</div>
     </div>
    <div class="rubric-section" style="flex-direction: row; justify-content: flex-start;align-items: center;">
      <input 

        type="text"
        id="rubric-input"
        class="rubric-input"
        placeholder="LVL-xxxxx"
      />      


      <div class="rubric-inline-actions">
      <button class="level-up-button" id="load-rubric-button">Add</button>
    </div>
    </div>

    <hr class="rubric-divider" />

    <!-- New Button -->
    <div class="rubric-section">
      <div class="rubric-label">Create Custom Rubric:</div>
      <div class="rubric-inline-actions">

      <button class="level-up-button" id="new-rubric-button">New</button>
      </div>
    </div>

  </div> <!-- scroll-container -->
</div> <!-- card -->





          <!-- NEW RUBRIC CARD -->
          <div class="card" id="customize-card-edit-newWindow" style="display: none; flex: 1;">
            <div class="scroll-container">
              <div class="card-title">Create New Rubric</div>
          
              <div class="card-main-text">You will be using Google Sheets to edit and update your rubric. Once you‚Äôve made changes, return here.</div>
            </div>
          </div>
  
        <!-- BEGIN .button-container (navigation buttons) -->
        <div class="button-container">
          <div class="button-left-group">
            <button id="back-button" class="nav-button">Back</button>
            <button id="home-button" class="nav-button">Back</button>
            <button id="skip-button" class="nav-button">Skip</button>

          </div>
          <div class="button-right-group">
            <button id="save" class="nav-button">Save Changes</button>
            <button id="next-button" class="nav-button">Next</button>
            <button id="submit-button" class="nav-button">Submit</button>
            <button id="start-edits-button" class="nav-button">Start Edits</button>
            <button id="check-work-button" class="nav-button">Check Work</button>
            <button id="save-rubric-button" class="nav-button">Save Rubric</button>
          </div>
        </div>
        <!-- END .button-container -->
  

      </div>
      <!-- END .button-box -->

      </div>
      <!-- END .content-wrapper -->
    </div>
    <!-- END #side-panel -->
  </body>
  
</html>

    <script>


// Global variables
let clientId = null;
let documentId = null;
let currentToken=null;
const backendURL = "http://localhost:3000";//"https://3f71-174-63-70-145.ngrok-free.app";
let currentPillCount = 0;
let ws = null;  // Global WebSocket instance
let messageQueue = [];  
let isReconnecting = false;
//ngrok http 3000


const defaultUIState= {
  currentPage: "home-page",
  waitingAnimationOn: true,
  visibleButtons: [],
  buttonsDisabled: [],
  level: 1,
  formerLevel: 1,
  animateLevelUp: false,
  timeSpentHours: 0,
  timeSpentMinutes: 0,
  copypasted: 0,
  selectedRubric: 0,
  listOfAvailableRubrics: [],
};

async function init() {
handleStateChange(defaultUIState);
connectWebSocket();
getStoredTokenData()


}
async function getDocumentData() {
  if (!clientId || !documentId) {
    console.error('No token data available');
    return null;
  }

  const payload = {
    clientId: clientId,
    documentId: documentId
  };

  const data= await sendToBackend("/get-data", payload);
  console.log(data);
}
async function sendToBackend(endpoint, payload) {
  try {
  const options = {
    method: "POST",
    contentType: "application/json",
    muteHttpExceptions: true,
    headers: {
        'Accept': 'application/json',
        'Content-Type': 'application/json',
        'ngrok-skip-browser-warning': 'true',
        'Origin': window.location.origin
      },
      body: JSON.stringify(payload)
  };

  const response = await fetch(backendURL + endpoint, options);
  if (!response.ok) {
      console.error(`Server responded with status: ${response.status}`);
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    try {
    return await response.json();
    } catch (e) {
      return response.text();  // Return as text if not JSON
    }
  } catch (e) {
    console.error("Error:", e.message);
    throw e;
  }
}
async function getStoredTokenData() {
  try {
    const response =   await fetch('./tokenData.json');
    if (!response.ok) {
      console.error('No token data found');
      return null;
    }
    const data = await response.json();
    return data;
  } catch (error) {
    console.error('Error reading token data:', error);
    return null;
  }
}

document.addEventListener('DOMContentLoaded', init);
    </script>


    <script>
          //Websocket
function connectWebSocket() {
  // Only create a new connection if one doesn't exist or is closed
  if (!ws || ws.readyState === WebSocket.CLOSED) {
    const wsUrl = backendURL.replace('http', 'ws');
    ws = new WebSocket(wsUrl);

    ws.onopen = () => {
      console.log('üü¢ WebSocket Connected');
      isReconnecting = false;
      sendTokenToServer();
      
      // Process any queued messages
      while (messageQueue.length > 0) {
        const message = messageQueue.shift();
        sendWebSocketMessage(message);
      }
    };

    ws.onmessage = handleWebSocketMessage;

    ws.onclose = () => {
      console.log('üî¥ WebSocket Disconnected');
      ws = null;
      
      // Attempt to reconnect after a delay
      setTimeout(() => {
        if (!ws || ws.readyState === WebSocket.CLOSED) {
          connectWebSocket();
        }
      }, 3000);
    };

    ws.onerror = (error) => {
      console.error('‚ùå WebSocket Error:', error);
    };
  }
}
// Initial connection

function sendWebSocketMessage(message) {
  if (ws && ws.readyState === WebSocket.OPEN) {
    try {
      ws.send(JSON.stringify(message));
      console.log('üì§ Sent:', message);
    } catch (error) {
      console.error('Failed to send message:', error);
      queueMessage(message);
    }
  } else {
    console.log('WebSocket not connected, queueing message');
    queueMessage(message);
    if (!isReconnecting) {
      connectWebSocket();
    }
  }
}

function queueMessage(message) {
  messageQueue.push(message);
  console.log('üì© Message queued. Queue size:', messageQueue.length);
}

function handleWebSocketMessage(event) {
  try {
    const data = JSON.parse(event.data);
    console.log('üì• Received:', data);
    
    switch(data.type) {
      case 'WELCOME':
        console.log('üëã Connected to server');
        break;
      case 'UPDATE_SCOPE_REQUEST':
        console.log('üîî Update scope message received:', data.message);
        handleUpdateScope();
        break;
      case 'STATE':
        console.log('üöå State Change Requested', data.payload);
        handleStateChange(data.payload);
        break;
      case 'EXTERNAL_PAGE_TO_OPEN':
        console.log('üîó Opening external page:', data.payload.url);
        window.open(data.payload.url, '_blank');
        break;
      case 'SHARE_RUBRIC_POPUP':
      console.log('ü•§ Share rubric popup received:', data.message);
        handleShareRubricPopup(data.payload);
        break;
      default:
        console.log('üìù Message received:', data);

        console.log('‚ö†Ô∏è Unhandled message type:', data.type);
    }
  } catch (error) {
    console.error('‚ùå Error processing message:', error);
  }
}
    </script>
    <script>
      let state={};
function handleStateChange(statePayload) {
  state = statePayload;

  console.log('üöå Changing State', state);

  // Hide all cards first
  document.querySelectorAll('.card').forEach(card => {
    card.style.display = 'none';
  });

  // Show the appropriate card based on current page
  const currentCard = document.getElementById(state.currentPage);
  if (currentCard) {
    currentCard.style.display = 'flex';
    currentCard.style.flex = '1';

    const subtitleElement = currentCard.querySelector('.card-title-subtitle');
    if (subtitleElement && state.cardSubtitle) {
      subtitleElement.textContent = state.cardSubtitle;
    }

    const mainTextElement = currentCard.querySelector('.card-main-text');
    if (mainTextElement && state.cardMainText) {
      mainTextElement.textContent = state.cardMainText;
    } 

    const errorMessageElement = currentCard.querySelector('.error-message');
    if (errorMessageElement && state.errorMessage) {
      errorMessageElement.innerHTML = state.errorMessage;
    }

  }

  // Handle loading spinner
  document.getElementById('spinner-overlay').style.display = 
    state.waitingAnimationOn ? 'flex' : 'none';

  // Handle navigation buttons
  const buttonVisibility = state.buttons;
  ['next-button', 'back-button', 'check-work-button', 'home-button', 'skip-button','submit-button', 'save-rubric-button','start-edits-button','edit-rubric-button','share-rubric-button','save'].forEach(buttonId => {
    const button = document.getElementById(buttonId);
    if (button) {
      button.style.display = state.visibleButtons?.includes(buttonId) ? 'flex' : 'none';
      button.disabled = state.buttonsDisabled?.includes(buttonId) || false;

    }
  });

  // Handle level display
  if (state.formerLevel) { //On level ups the former level needs to start, then former level becomes level
    document.querySelector('.pixelated-gradient-text').textContent = `Level ${state.formerLevel}`;
  }



  // Handle pill buttons
    // Only update pills if they've changed
// Only rebuild pills if the count changed
if (state.pills) {
    createPillStructure(state.pills);
    updatePillProgress(state.pills);
  }

//update copyPasted text and time spent text.
document.getElementById('copyPasted').textContent = state.copypasted+"%";
document.getElementById('timeSpent').textContent = state.timeSpentHours + " hours and " + state.timeSpentMinutes + " minutes";





  //Handle task feedback

    const alertDiv = document.querySelector('#challenge-card .alert-message');
    const failReasonDiv = document.querySelector('#challenge-card .fail-reason-message');
    alertDiv.style.display = 'none';
    failReasonDiv.style.display = 'none';
    if (state.taskFeedback) {
      switch(state.taskFeedback) {
      case 'no-changes':
      if (alertDiv) {
        alertDiv.className = "alert-message info";
        alertDiv.style.display = 'block';
        alertDiv.innerHTML = "‚ö†Ô∏è Make the suggested changes before clicking submit!";
      }
      break;
      case 'wrong-location':
      if (alertDiv) {
        alertDiv.style.display = 'block';
        alertDiv.className = "alert-message info";
        alertDiv.innerHTML = `‚ö†Ô∏è Please only edit around the highlighted sentence during Level Up.

        I can't find the original sentence now, and we'll need to choose a new challenge.`;
      }
      break;
      case 'incorrect':
      if (alertDiv) {
        alertDiv.className = "alert-message error";
        alertDiv.style.display = 'block';
        alertDiv.className = "alert-message error";
        alertDiv.innerHTML = "‚ùå Challenge Failed.";
      }
      if (failReasonDiv) {
        failReasonDiv.style.display = 'block';
        failReasonDiv.innerHTML = state.taskFeedbackMessage;
      }
      break;
    }
  }

    // 9. Handle reflection card content
    if (state.reflection) {
    const questionElement = document.querySelector('#reflection-card .reflection-question');
    const textArea = document.querySelector('#reflection-card textarea');
    if (questionElement && state.reflection.question) {
      questionElement.innerHTML = state.reflection.question[state.reflection.selectedQuestion];
    }
    if (textArea && state.reflection.placeholder) {
      textArea.placeholder = state.reflection.placeholder;
    }
    if(state.reflection.selectedQuestion < state.reflection.submittedAnswers.length){
      textArea.value = state.reflection.submittedAnswers[state.reflection.selectedQuestion];
    }
    else{
      textArea.value = "";
    }


      const reflectionWarning = document.querySelector('.reflection-warning');
      if (state.reflection.noInputOnSubmit) {
        reflectionWarning.style.display = 'block';
      }
      else{
        reflectionWarning.style.display = 'none';
      }
    
  
    }
  



    //Handle Rubrics:
    if (Array.isArray(state.listOfAvailableRubrics) && state.listOfAvailableRubrics.length > 0) {
  const rubricDropdown = document.getElementById('rubric-dropdown');

  if (rubricDropdown) {
    rubricDropdown.innerHTML = state.listOfAvailableRubrics
      .map((rubric, index) => {
        const isSelected = index === state.selectedRubric ? 'selected' : '';
        return `<option value="${index}" ${isSelected}>${rubric}</option>`;
      })
      .join('');
  }
}

  const rubricLabel = document.getElementById('rubric-import-label');

if (state.importError) {
  rubricLabel.classList.add('rubric-error');
  rubricLabel.textContent = `${state.importError}`;
} else {
  rubricLabel.classList.remove('rubric-error');
  rubricLabel.textContent = "Import Rubric:";
}




if (!state.waitingAnimationOn) {
    enableAllButtons();
  }


  if (state.animateLevelUp) {
increaseLevel(state.formerLevel,state.level);
}
  setTimeout(() => {
            checkScrollOverflow();
          }, 0);
          

}



  function createPillStructure(pills) {
  const pillHolder = document.getElementById('pillHolder');
  if (!pillHolder) return;

  pillHolder.innerHTML = ''; 
  pills.forEach((pill, index) => {
    const button = document.createElement('button');
    button.className = 'topic-button';
    button.setAttribute('data-pill-index', index.toString());
    button.innerHTML = `
      <div class="progress-bar">
        <div class="inner-pill"></div>
        <div class="inner-empty-pill"></div>
        <span class="progress-text"></span>
      </div>
      <span class="label">${pill.title}</span>
    `;
    button.onclick = () => handlePillClick(index);
    pillHolder.appendChild(button);
  });

  
  if (state.reflection.enabled) {
    const reflectionButton = document.createElement('button');
    reflectionButton.className = 'topic-button';
    reflectionButton.setAttribute('data-pill-index', "-1");
    reflectionButton.innerHTML = `
      <div class="progress-bar">
        <div class="inner-pill"></div>
        <div class="inner-empty-pill"></div>
        <span class="progress-text"></span>
      </div>
      <span class="label">Reflection</span>
    `;
    reflectionButton.onclick = () => handlePillClick(-1);
    pillHolder.appendChild(reflectionButton);
  }

}


function updatePillProgress(pills) {
  pills.forEach((pill, index) => {
    const button = document.querySelector(`[data-pill-index="${index}"]`);
    if (button) {
      const emptyPill = button.querySelector('.inner-empty-pill');
      const progressText = button.querySelector('.progress-text');
      
      if (emptyPill && progressText) {
        emptyPill.style.width = `${100 - (pill.current/pill.outOf * 100)}%`;
        progressText.textContent = `${pill.current}/${pill.outOf}`;
      }
    }
  });
  //reflection pill
  if(state.reflection.enabled){
  const reflectionButton = document.querySelector('[data-pill-index="-1"]');
  if(reflectionButton){
    const emptyPill = reflectionButton.querySelector('.inner-empty-pill');
    const progressText = reflectionButton.querySelector('.progress-text');
    if (emptyPill && progressText) {
      emptyPill.style.width = `${100 - (state.reflection.currentScore/state.reflection.outOf * 100)}%`;
      progressText.textContent = `${state.reflection.currentScore}/${state.reflection.outOf}`;
    }
    }
  }



  }


function checkScrollOverflow() {
  const currentCardType = state.currentPage;
          const currentCard = document.getElementById(currentCardType);
          const buttonBox = document.querySelector(".button-box");
          const buttonContainer = document.querySelector(".button-container");

          if (currentCard) {
            // Find the scroll container within the current card
            const container = currentCard.querySelector(".scroll-container");
            container.scrollTop=0;
            if (container) {
              // Check if content is taller than container
              const hasOverflow = 
                container.scrollHeight > container.clientHeight;

              // Add or remove is-scrollable class from both elements
              if (hasOverflow) {
                buttonBox.classList.add("is-scrollable");
                container.classList.add("is-scrollable");
                buttonContainer.classList.add("is-scrollable");
              } else {
                buttonBox.classList.remove("is-scrollable");
                container.classList.remove("is-scrollable");
                buttonContainer.classList.remove("is-scrollable");
              }
            }
          }
  }


    

  // Handle level-up animation if requested

function disableAllButtons() {
  document.querySelectorAll('button').forEach(button => {
    button.classList.add('no-clicks');
  });
}

function enableAllButtons() {
  document.querySelectorAll('button').forEach(button => {
    button.classList.remove('no-clicks');
  });
}

</script>

    <script>
          //Utilty functions


          function handleUpdateScope() {
sendTokenToServer();
      }

      function handleShareRubricPopup(payload) {
        if(isGoogleApp()) {
          callGoogleAppFunction('openSharePopUp', null,null, payload.rubricID, payload.rubricName, payload.rubricLink);
        }

          console.log('ü•§ Sent Pop Up Request:', payload);

      

      }

  async function sendTokenToServer() {
        if(isGoogleApp()) {

    callGoogleAppFunction('updateTokenData', receivedTokenData, googleServerError);
    //currentToken will be an object with clientId, documentId, and token
  }
  else{
    receivedTokenData(await getStoredTokenData());
  }
  }
function receivedTokenData(currentToken) {
  if (currentToken) {
    clientId = currentToken.clientId;
    documentId =  currentToken.documentId;
  }
  sendWebSocketMessage({
    type: "GIVE_TOKEN",
    payload: {
        clientId: currentToken.clientId,
        documentId: currentToken.documentId,
        token: currentToken.token
    }
});
}
  

function callGoogleAppFunction(functionName, successHandler = () => {}, failureHandler = console.error, ...args) {
  google.script.run
    .withSuccessHandler(successHandler)
    .withFailureHandler(failureHandler)
    [functionName](...args);
}

function googleServerError(error) {
  //todo: tell the server gracefully and it will navigate us to error page.
  console.error('Google Server Error:', error);
}

function isGoogleApp() {
  return typeof google !== 'undefined' && google.script;
}
    </script>

    <script>
function setupEventHandlers() {
  // Button clicks
  ['next-button', 'back-button', 'check-work-button', 'home-button', 'skip-button', 'submit-button', 'edit-rubric-button','new-rubric-button','start-edits-button','share-rubric-button','load-rubric-button','save'].forEach(buttonId => {
    const button = document.getElementById(buttonId);
    if (button) {
      button.onclick = () => {

        disableAllButtons();
        messageQueue = []; // Clear any queued messages

        if ((buttonId === "next-button" || buttonId === "submit-button") && state.currentPage === "reflection-card") {
          sendWebSocketMessage({
            type: 'BUTTON_CLICKED',
            payload: {
              buttonId: buttonId,
              clientId: clientId,
              documentId: documentId,
              textResponse: document.querySelector('.reflection-textarea')?.value || ''
            }
          });
        }else if(buttonId === "load-rubric-button"){
          const inputValue = document.getElementById("rubric-input")?.value;
          if(inputValue !== "" && inputValue !== undefined){
          sendWebSocketMessage({
            type: 'BUTTON_CLICKED',
            payload: {

              buttonId: buttonId,
              clientId: clientId,
              documentId: documentId,
              importDocumentId: inputValue
            }  
          });
          }
          else{
            state.importError = "Missing Rubric ID.";
            handleStateChange(state);
          }



        }
        else {
          sendWebSocketMessage({

            type: 'BUTTON_CLICKED',
            payload: {
              buttonId: buttonId,
              clientId: clientId,
              documentId: documentId
            }
          });
        }
      };
    }
  });

  // Add event handler for the "Customize" link
  const customizeLink = document.querySelector('.customize-link');
  if (customizeLink) {
    customizeLink.onclick = (event) => {
      event.preventDefault(); // Prevent default link behavior
      disableAllButtons();
      sendWebSocketMessage({
        type: 'CUSTOMIZE_CLICKED',
        payload: {
          clientId: clientId,
          documentId: documentId
        }
      });
    };
  }




  // Reflection submit
  const reflectionForm = document.querySelector('#reflection-card form');
  if (reflectionForm) {
    reflectionForm.onsubmit = (e) => {
      e.preventDefault();
      const textarea = reflectionForm.querySelector('textarea');
      if (textarea) {
        sendWebSocketMessage({
          type: 'action',
          payload: {
            type: 'reflection-submit',
            text: textarea.value
          }
        });
      }
    };
  }

    //Rubric dropdown

  const rubricDropdown = document.getElementById("rubric-dropdown");

if (rubricDropdown) {
  rubricDropdown.addEventListener("change", function () {
    const selectedIndex = this.selectedIndex; // Get the index of the selected option
    const selectedValue = this.value; // Get the rubric name
    
    console.log(`Dropdown clicked: Index ${selectedIndex}, Value: ${selectedValue}`);

    sendWebSocketMessage({
      type: "BUTTON_CLICKED",
      payload: {
        buttonId: "rubric-dropdown",
        selectedIndex: selectedIndex,
        clientId: clientId,
        documentId: documentId
      }
    });
  });
}

}
// Call this after the DOM is loaded
document.addEventListener('DOMContentLoaded', setupEventHandlers);

function handlePillClick(pillButtonId){
        sendWebSocketMessage({
          type: 'BUTTON_CLICKED',
          payload: {
            buttonId: 'pill-button',
            buttonTitle: pillButtonId,
            clientId: clientId,
            documentId: documentId
          }
        });
      }

 

    </script>
    <script>
//test functions
function testConnectionLoss() {
    // Force close the connection
    if (ws) {
        console.log("üß™ Testing: Forcing WebSocket close");
        ws.close();
        
        // Try to send a message right after
        setTimeout(() => {
            console.log("üß™ Testing: Sending message while disconnected");
            sendWebSocketMessage({
                type: 'action',
                payload: {
                    type: 'test',
                    message: 'This message should be queued'
                }
            });
        }, 100);
    }
}

function testMessageQueue() {
    console.log("üß™ Testing: Sending multiple messages while disconnected");
    // Force close first
    if (ws) ws.close();
    
    // Send multiple messages
    for(let i = 1; i <= 3; i++) {
        sendWebSocketMessage({
            type: 'action',
            payload: {
                type: 'test',
                message: `Queued message ${i}`
            }
        });
    }
    

}
</script>

<script>
        const backgroundSystem = {
        imageUrls: [
          "https://wondersa.blob.core.windows.net/levelup/1.png",
          "https://wondersa.blob.core.windows.net/levelup/2.png",
          "https://wondersa.blob.core.windows.net/levelup/3.png",
        ],
        pxPerLevel: 100,
        levelsPerImage: 10,
        totalPxPerImage: 1000,

        getRequiredImages(currentLevel) {
          const totalPxNeeded = currentLevel * this.pxPerLevel;
          return Math.ceil(totalPxNeeded / this.totalPxPerImage);
        },

        getNextImageUrl(imageIndex) {
          return this.imageUrls[imageIndex % this.imageUrls.length];
        },
      };
  //Level Up Box Animations
  function adjustColors(baseColor) {
    document.documentElement.style.setProperty("--base-blue", baseColor);
    const textContainer = document.querySelector(".text-container");
    textContainer.style.backgroundColor = baseColor;
    const icons = document.querySelectorAll(".home-icon, .settings-icon");
    icons.forEach((icon) => {
      icon.style.fill = baseColor;
    });
  }

  function increaseLevel(startLevel,targetLevel) {

    setTimeout(() => {
      const levelText = document.querySelector(".pixelated-gradient-text");

  
      let currentLevel = startLevel;

      // Calculate total distance to move
      const totalDistance = (targetLevel - startLevel) * 100;
      const levelsToAnimate = targetLevel - startLevel;

      // Animate balloon and background

      const hotAirBalloon = document.querySelector(".hot-air-balloon");

      // Start balloon animation
      hotAirBalloon.style.transform = "translateY(-40px)";
      hotAirBalloon.src =
        "https://wondersa.blob.core.windows.net/levelup/hotAirBaloonFire.png";

      updateBackgroundImages(targetLevel);

      // Animate level counting up
      const adventureImage = document.querySelector(
        ".adventure-image-container"
      );
      adventureImage.style.height = `${targetLevel * 100}px`;
      // Start the level animation
      const delay = 1500 / levelsToAnimate;

      setTimeout(animateLevels(currentLevel, targetLevel, delay), delay);
    }, 100);

    function updateBackgroundImages(targetLevel) {
      const container = document.querySelector(
        ".adventure-image-container"
      );
      const imagesNeeded = backgroundSystem.getRequiredImages(targetLevel);

      // Create/update images as needed
      for (let i = 0; i < imagesNeeded; i++) {
        const imageUrl = backgroundSystem.getNextImageUrl(i);

        // Only create new image if it doesn't exist
        if (!container.querySelector(`[data-image-index="${i}"]`)) {
          console.log(
            `Adding new image for level ${targetLevel}, image index ${i}`
          );
          const img = document.createElement("img");
          img.src = imageUrl;
          img.className = "adventure-image";
          img.dataset.imageIndex = i;
          img.style.position = "absolute";
          img.style.bottom = `${i * backgroundSystem.totalPxPerImage}px`;
          img.style.width = "100%";
          container.appendChild(img);
        }
      }
    }

    function animateLevels(currentLevel, targetLevel, delay) {
      const levelText = document.querySelector(".pixelated-gradient-text");
      if (currentLevel < targetLevel) {
        currentLevel++;
        setTimeout(() => {
          levelText.textContent = `Level ${currentLevel}`;
        }, delay);
        setTimeout(animateLevels, delay, currentLevel, targetLevel, delay);
      } else {
        // Final animations after reaching target level
        finishLevelAnimation();
      }
    }

    function finishLevelAnimation() {
      const levelTextContainer = document.querySelector(
        ".level-text-container"
      );
      const levelText = document.querySelector(".pixelated-gradient-text");
      // Your existing final animation code
      const textContainer = document.querySelector(".text-container");
      const hotAirBalloon = document.querySelector(".hot-air-balloon");
      const currentWidth = parseFloat(
        getComputedStyle(levelTextContainer).width
      );
      const currentHeight = parseFloat(
        getComputedStyle(levelTextContainer).height
      );

      setTimeout(() => {
        const currentWidth = parseFloat(
          getComputedStyle(levelTextContainer).width
        );
        const currentHeight = parseFloat(
          getComputedStyle(levelTextContainer).height
        );

        levelTextContainer.style.width = `${currentWidth * 1.05}px`;
        levelTextContainer.style.height = `${currentHeight * 1.05}px`;

        setTimeout(() => {
          levelTextContainer.style.width = `${currentWidth}px`;
          levelTextContainer.style.height = `${currentHeight}px`;

          setTimeout(() => {
            textContainer.style.animation = "";
            const originalColors = {
              dark: getComputedStyle(document.documentElement)
                .getPropertyValue("--gradient-dark")
                .trim(),
              medium: getComputedStyle(document.documentElement)
                .getPropertyValue("--gradient-medium")
                .trim(),
              light: getComputedStyle(document.documentElement)
                .getPropertyValue("--gradient-light")
                .trim(),
            };

            document.documentElement.style.setProperty(
              "--gradient-dark",
              "#ffffff"
            );

            setTimeout(() => {
              document.documentElement.style.setProperty(
                "--gradient-dark",
                originalColors.dark
              );
              document.documentElement.style.setProperty(
                "--gradient-medium",
                "#ffffff"
              );

              setTimeout(() => {
                document.documentElement.style.setProperty(
                  "--gradient-medium",
                  originalColors.medium
                );
                document.documentElement.style.setProperty(
                  "--gradient-light",
                  "#ffffff"
                );

                setTimeout(() => {
                  document.documentElement.style.setProperty(
                    "--gradient-light",
                    originalColors.light
                  );

                  hotAirBalloon.style.transform = "translateY(0px)"; // Move back to original position
                  hotAirBalloon.src =
                    "https://wondersa.blob.core.windows.net/levelup/hotAirBaloon.png"; // Change back to original image
                }, 100);
              }, 200);
            }, 400);
          }, 400);
        }, 200);
      }, 200);
    }
  }
</script>
<script>
  //Browswer code
  document.addEventListener("visibilitychange", () => {
    if (document.visibilityState === "visible") {
        sendWebSocketMessage({
          type: "USER_BACK_ON_TAB",
          payload: {
            clientId: clientId,
            documentId: documentId
          }
        });
    } 
  });


</script>

